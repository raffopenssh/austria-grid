<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Windkraft Österreich - Netzkapazität für Windenergieanlagen | Interaktive Karte</title>
    <meta name="title" content="Windkraft Österreich - Netzkapazität für Windenergieanlagen">
    <meta name="description" content="Interaktive Karte der österreichischen Windkraftanlagen und Netzkapazitäten. Analysieren Sie verfügbare Einspeisekapazitäten für neue Windenergieprojekte nach Bezirk.">
    <meta name="keywords" content="Windkraft, Österreich, Netzkapazität, Windenergie, Erneuerbare Energie, Windpark, Stromeinspeisung, APG, E-Control, Umspannwerk">
    <meta name="author" content="Austria Wind Grid">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://austria-power.exe.xyz:8000/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://austria-power.exe.xyz:8000/">
    <meta property="og:title" content="Windkraft Österreich - Netzkapazität für Windenergieanlagen">
    <meta property="og:description" content="Interaktive Karte der österreichischen Windkraftanlagen und Netzkapazitäten. Analysieren Sie verfügbare Einspeisekapazitäten für neue Windenergieprojekte.">
    <meta property="og:image" content="https://austria-power.exe.xyz:8000/static/og-image.png">
    <meta property="og:locale" content="de_AT">
    <meta property="og:site_name" content="Windkraft Österreich">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://austria-power.exe.xyz:8000/">
    <meta name="twitter:title" content="Windkraft Österreich - Netzkapazität für Windenergieanlagen">
    <meta name="twitter:description" content="Interaktive Karte der österreichischen Windkraftanlagen und Netzkapazitäten.">
    <meta name="twitter:image" content="https://austria-power.exe.xyz:8000/static/og-image.png">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Windkraft Österreich - Netzkapazität",
        "description": "Interaktive Karte der österreichischen Windkraftanlagen und Netzkapazitäten",
        "url": "https://austria-power.exe.xyz:8000/",
        "applicationCategory": "Utility",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "author": {
            "@type": "Organization",
            "name": "Austria Wind Grid"
        }
    }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eaeaea;
        }
        
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #00d4aa;
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: #00d4aa;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #888;
            font-size: 0.9rem;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        .sidebar {
            width: 350px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .panel {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        
        .panel h3 {
            color: #00d4aa;
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #00d4aa;
        }
        
        .stat-value.negative {
            color: #ff6b6b;
        }
        
        .stat-value.warning {
            color: #ffd93d;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(26, 26, 46, 0.95);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #333;
        }
        
        .legend h4 {
            color: #00d4aa;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
        
        .layer-controls {
            margin-top: 15px;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        
        .layer-toggle input {
            margin-right: 10px;
            accent-color: #00d4aa;
        }
        
        .district-info {
            display: none;
        }
        
        .district-info.active {
            display: block;
        }
        
        .capacity-bar {
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .capacity-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 10px;
        }
        
        .info-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #c23616 100%);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
        
        .info-banner strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .tooltip-custom {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid #00d4aa !important;
            border-radius: 8px !important;
            padding: 10px !important;
            color: #fff !important;
        }
        
        .tooltip-custom .title {
            color: #00d4aa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: #16213e;
            border: 2px solid #00d4aa;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: #00d4aa;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #ff6b6b;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-section {
            margin-bottom: 20px;
        }
        
        .modal-section h3 {
            color: #00d4aa;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .modal-row:last-child {
            border-bottom: none;
        }
        
        .modal-label {
            color: #888;
        }
        
        .modal-value {
            color: #fff;
            font-weight: bold;
        }
        
        .modal-value.positive {
            color: #00d4aa;
        }
        
        .modal-value.negative {
            color: #ff6b6b;
        }
        
        .modal-value.warning {
            color: #ffd93d;
        }
        
        .capacity-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .capacity-bar-modal {
            flex: 1;
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .capacity-bar-modal-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s;
        }
        
        .ranking-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            margin: 2px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .ranking-item:hover {
            background: rgba(0, 212, 170, 0.2);
        }
        
        .ranking-item .rank {
            color: #888;
            width: 20px;
        }
        
        .ranking-item .name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 8px;
        }
        
        .ranking-item .value {
            color: #00d4aa;
            font-weight: bold;
        }
        
        .ranking-item.bottom .value {
            color: #ff6b6b;
        }
        
        /* Night mode toggle styling */
        .night-mode-toggle {
            background: linear-gradient(135deg, #1a0a1a 0%, #0a0a15 100%);
            border-radius: 6px;
            padding: 8px 10px !important;
            margin-top: 8px;
        }
        
        .night-mode-toggle i {
            color: #ffd93d;
            margin-right: 5px;
        }
        
        /* Night mode active state */
        body.night-mode {
            background: #0a0a0f;
        }
        
        body.night-mode .header {
            background: linear-gradient(135deg, #0a0a15 0%, #050508 100%);
            border-bottom-color: #ff3333;
        }
        
        body.night-mode .header h1 {
            color: #ff4444;
        }
        
        body.night-mode .sidebar {
            background: #0a0a12;
        }
        
        body.night-mode .panel {
            background: #050508;
            border-color: #222;
        }
        
        body.night-mode .panel h3 {
            color: #ff4444;
        }
        
        /* Red glow effect for lighted turbines in night mode */
        .leaflet-nightLightsPane-pane path {
            filter: drop-shadow(0 0 4px rgba(255, 50, 50, 0.9)) drop-shadow(0 0 10px rgba(255, 0, 0, 0.7));
        }
        
        @keyframes red-pulse {
            0%, 100% {
                filter: drop-shadow(0 0 4px rgba(255, 50, 50, 0.8)) drop-shadow(0 0 8px rgba(255, 0, 0, 0.5));
                opacity: 0.85;
            }
            50% {
                filter: drop-shadow(0 0 8px rgba(255, 50, 50, 1)) drop-shadow(0 0 16px rgba(255, 0, 0, 0.9));
                opacity: 1;
            }
        }
        
        body.night-mode .leaflet-nightLightsPane-pane path {
            animation: red-pulse 2s ease-in-out infinite;
        }
        
        /* Night mode map styling */
        body.night-mode .leaflet-tile-pane {
            filter: brightness(0.35) saturate(0.5);
        }
        
        body.night-mode .leaflet-heatmapPane-pane {
            opacity: 0.25;
        }
        
        body.night-mode .leaflet-turbinePane-pane path {
            opacity: 0.4;
        }
        
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Modal for details -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>
    
    <div class="header">
        <h1><i class="fas fa-wind"></i> Netzkapazität für Windenergie in Österreich</h1>
        <p>Bezirksweise Analyse der verfügbaren Einspeisekapazitäten für neue Windkraftanlagen</p>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="info-banner">
                <strong><i class="fas fa-exclamation-triangle"></i> Hinweis zur Datenqualität</strong>
                Die offiziellen Kapazitätsangaben der Netzbetreiber sind oft pessimistisch. 
                Diese Analyse schätzt realistische verfügbare Kapazitäten basierend auf 
                tatsächlicher Auslastung und internationalen Erfahrungswerten.
            </div>
            
            <div class="panel">
                <h3><i class="fas fa-chart-pie"></i> Österreich Gesamt</h3>
                <div class="stat-row">
                    <span class="stat-label">Installierte Leistung</span>
                    <span class="stat-value" id="total-capacity">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Windkraftanlagen</span>
                    <span class="stat-value" id="total-turbines">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Geschätzte Leistung</span>
                    <span class="stat-value" id="total-estimated-mw">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Umspannwerke</span>
                    <span class="stat-value" id="total-transformers">-</span>
                </div>
            </div>
            
            <div class="panel">
                <h3><i class="fas fa-bolt"></i> Erzeugung 2024</h3>
                <div class="stat-row">
                    <span class="stat-label">Windstrom gesamt</span>
                    <span class="stat-value positive" id="production-2024">-</span>
                </div>
                <div class="chart-container">
                    <canvas id="production-chart"></canvas>
                </div>
            </div>
            
            <div class="panel" id="turbine-ranking">
                <h3><i class="fas fa-trophy"></i> Windkraftanlagen im Blickfeld</h3>
                <div class="ranking-section">
                    <h4 style="color: #00d4aa; font-size: 0.85rem; margin: 10px 0 5px 0;">Top 10 (beste Netzkapazität)</h4>
                    <div id="top-turbines" class="ranking-list"></div>
                </div>
            </div>
            
            <div class="panel district-info" id="district-panel">
                <h3><i class="fas fa-map-marker-alt"></i> <span id="district-name">-</span></h3>
                <div class="stat-row">
                    <span class="stat-label">Installierte Leistung</span>
                    <span class="stat-value" id="district-installed">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Windparks</span>
                    <span class="stat-value" id="district-windparks">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Umspannwerke</span>
                    <span class="stat-value" id="district-transformers">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Offiz. verfügbar</span>
                    <span class="stat-value warning" id="district-official">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Geschätzt verfügbar</span>
                    <span class="stat-value positive" id="district-estimated">-</span>
                </div>
                <div>
                    <small style="color: #888;">Kapazitätsauslastung</small>
                    <div class="capacity-bar">
                        <div class="capacity-bar-fill" id="capacity-bar"></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3><i class="fas fa-layer-group"></i> Kartenebenen</h3>
                <div class="layer-controls">
                    <label class="layer-toggle">
                        <input type="checkbox" id="layer-heatmap" checked>
                        Kapazitäts-Heatmap
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" id="layer-windparks" checked>
                        Windkraftanlagen
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" id="layer-transformers">
                        Umspannwerke
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" id="layer-grid">
                        Hochspannungsnetz (APG)
                    </label>
                    <label class="layer-toggle night-mode-toggle">
                        <input type="checkbox" id="layer-nightmode">
                        <i class="fas fa-moon"></i> Nachtmodus
                    </label>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <h4>Kapazität für Zubau</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00d4aa;"></div>
                    Hoch (>70%)
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffd93d;"></div>
                    Mittel (30-70%)
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    Niedrig (<30%)
                </div>
                <div class="legend-item" style="margin-top: 10px;">
                    <div class="legend-color" style="background: linear-gradient(to right, rgb(68,1,84), rgb(49,104,142), rgb(53,183,121), rgb(253,231,37)); border-radius: 50%; border: 2px solid #fff; width: 14px; height: 14px;"></div>
                    Windkraftanlage
                </div>
                <div style="display: flex; align-items: center; font-size: 0.7rem; color: #888; margin-left: 22px; margin-top: 2px;">
                    <span>1 MW</span>
                    <div style="flex: 1; height: 6px; margin: 0 5px; background: linear-gradient(to right, rgb(68,1,84), rgb(49,104,142), rgb(53,183,121), rgb(253,231,37)); border-radius: 3px;"></div>
                    <span>7 MW</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #ff3c3c, #ffffff); border-radius: 2px; border: 2px solid #fff; width: 14px; height: 14px;"></div>
                    Umspannwerk
                </div>
                <div class="legend-item night-mode-legend" style="display: none;">
                    <div class="legend-color" style="background: #ff2222; border-radius: 50%; border: 2px solid #ff0000; box-shadow: 0 0 8px rgba(255,0,0,0.8); width: 12px; height: 12px;"></div>
                    Befeuerung (Nacht)
                </div>
                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #333;">
                    <a href="#" onclick="showSourcesModal(); return false;" style="color: #666; font-size: 0.7rem; text-decoration: none;">
                        <i class="fas fa-info-circle"></i> Quellen & Methodik
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sources Modal -->
    <div id="sources-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px; padding: 20px;">
            <span class="modal-close" onclick="closeSourcesModal()">&times;</span>
            <h2 style="color: #00d4aa; margin-bottom: 15px;"><i class="fas fa-database"></i> Datenquellen</h2>
            <div style="font-size: 0.85rem; line-height: 1.6;">
                <p style="margin-bottom: 10px;"><strong>Windkraftanlagen:</strong><br>
                <a href="https://www.igwindkraft.at" target="_blank" style="color: #4a9eff;">IG Windkraft</a> – Standortdaten österreichischer Windkraftanlagen</p>
                
                <p style="margin-bottom: 10px;"><strong>Netzkapazitäten:</strong><br>
                <a href="https://www.e-control.at" target="_blank" style="color: #4a9eff;">E-Control Austria</a> – Einspeisekapazitäten der Netzbetreiber</p>
                
                <p style="margin-bottom: 10px;"><strong>Umspannwerke:</strong><br>
                <a href="https://www.apg.at" target="_blank" style="color: #4a9eff;">APG (Austrian Power Grid)</a> – Transformatorstationen und Netzinfrastruktur</p>
                
                <p style="margin-bottom: 10px;"><strong>Erzeugungsdaten:</strong><br>
                <a href="https://www.apg.at/de/markt/Markttransparenz" target="_blank" style="color: #4a9eff;">APG Markttransparenz</a> – Windstromerzeugung 2024</p>
                
                <p style="margin-bottom: 10px;"><strong>Bezirksgrenzen:</strong><br>
                <a href="https://www.data.gv.at" target="_blank" style="color: #4a9eff;">data.gv.at</a> – Open Government Data Austria</p>
                
                <p style="margin-bottom: 10px;"><strong>Hindernisbefeuerung:</strong><br>
                <a href="https://sdimd-free.austrocontrol.at/" target="_blank" style="color: #4a9eff;">Austro Control</a> – Hindernisdatenbank Österreich (Nachtmodus)</p>
            </div>
            
            <h2 style="color: #00d4aa; margin: 20px 0 15px 0;"><i class="fas fa-cogs"></i> Methodik</h2>
            <div style="font-size: 0.85rem; line-height: 1.6; color: #aaa;">
                <p style="margin-bottom: 10px;"><strong>Kapazitätsschätzung:</strong> Die verfügbare Netzkapazität wird aus den offiziellen Netzbetreiber-Angaben abgeleitet. Da diese oft konservativ sind, werden zusätzliche Faktoren wie internationale Erfahrungswerte berücksichtigt.</p>
                
                <p style="margin-bottom: 10px;"><strong>Turbinenleistung:</strong> Die geschätzte Leistung (MW) basiert auf der Nabenhöhe und typischen Leistungskurven moderner Windkraftanlagen.</p>
                
                <p><strong>Visualisierung:</strong> Farbskalen verwenden Viridis (Turbinen) und einen Rot-Weiß-Gradienten (Umspannwerke) für optimale Unterscheidbarkeit.</p>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; font-size: 0.75rem; color: #666;">
                Stand: Januar 2025 · Keine Gewähr für Vollständigkeit oder Richtigkeit
            </div>
        </div>
    </div>
    
    <script>
        // Initialize map centered on Austria
        const map = L.map('map').setView([47.5, 14.5], 7);
        
        // Dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create custom panes for layer ordering
        map.createPane('gridPane');
        map.getPane('gridPane').style.zIndex = 350;
        
        map.createPane('heatmapPane');
        map.getPane('heatmapPane').style.zIndex = 400;
        
        map.createPane('turbinePane');
        map.getPane('turbinePane').style.zIndex = 450;
        
        map.createPane('transformerPane');
        map.getPane('transformerPane').style.zIndex = 500;
        
        // Layer groups
        const gridLayer = L.layerGroup();
        const heatmapLayer = L.layerGroup().addTo(map);
        const windparksLayer = L.layerGroup().addTo(map);
        const transformersLayer = L.layerGroup();
        const nightLightsLayer = L.layerGroup();
        
        // Create pane for night lights (above turbines)
        map.createPane('nightLightsPane');
        map.getPane('nightLightsPane').style.zIndex = 460;
        
        // Data storage
        let districtData = {};
        let turbinesData = [];
        let turbineMarkers = [];
        let nightLightMarkers = [];
        let transformersData = [];
        let bezirkeGeoJSON = null;
        let nightModeActive = false;
        
        // Color scale for capacity
        function getCapacityColor(score) {
            if (score >= 70) return '#00d4aa';
            if (score >= 30) return '#ffd93d';
            return '#ff6b6b';
        }
        
        // Viridis color scale for turbine power (MW)
        // Turbine power ranges from ~1 MW to ~7 MW
        const TURBINE_MW_MIN = 1.0;
        const TURBINE_MW_MAX = 7.0;
        
        function getTurbinePowerColor(mw) {
            // Normalize to 0-1 range
            const t = Math.max(0, Math.min(1, (mw - TURBINE_MW_MIN) / (TURBINE_MW_MAX - TURBINE_MW_MIN)));
            
            // Viridis color scale (approximation)
            // From dark purple (low) to yellow (high)
            const viridis = [
                [68, 1, 84],      // 0.0 - dark purple
                [72, 40, 120],    // 0.125
                [62, 74, 137],    // 0.25
                [49, 104, 142],   // 0.375
                [38, 130, 142],   // 0.5 - teal
                [31, 158, 137],   // 0.625
                [53, 183, 121],   // 0.75
                [109, 205, 89],   // 0.875
                [253, 231, 37]    // 1.0 - yellow
            ];
            
            // Interpolate between colors
            const idx = t * (viridis.length - 1);
            const i = Math.floor(idx);
            const f = idx - i;
            
            if (i >= viridis.length - 1) {
                return 'rgb(' + viridis[viridis.length - 1].join(',') + ')';
            }
            
            const c1 = viridis[i];
            const c2 = viridis[i + 1];
            const r = Math.round(c1[0] + f * (c2[0] - c1[0]));
            const g = Math.round(c1[1] + f * (c2[1] - c1[1]));
            const b = Math.round(c1[2] + f * (c2[2] - c1[2]));
            
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }
        
        function getCapacityOpacity(score) {
            return 0.4 + (score / 100) * 0.4;
        }
        
        // Format numbers
        function formatNumber(num) {
            return num.toLocaleString('de-AT');
        }
        
        // Load and display district heatmap
        async function loadDistrictHeatmap() {
            const [bezirkeResponse, capacityResponse] = await Promise.all([
                fetch('/api/bezirke'),
                fetch('/api/district-capacity')
            ]);
            
            bezirkeGeoJSON = await bezirkeResponse.json();
            districtData = await capacityResponse.json();
            
            // Calculate totals
            let totalCapacity = 0;
            let totalWindparks = 0;
            let totalTurbines = 0;
            let totalTransformers = 0;
            
            Object.values(districtData).forEach(d => {
                totalCapacity += d.installed_mw;
                totalWindparks += d.windparks;
                totalTurbines += d.turbines;
                totalTransformers += d.transformers;
            });
            
            document.getElementById('total-capacity').textContent = formatNumber(Math.round(totalCapacity)) + ' MW';
            document.getElementById('total-transformers').textContent = formatNumber(totalTransformers);
            
            // Add GeoJSON layer
            L.geoJSON(bezirkeGeoJSON, {
                pane: 'heatmapPane',
                style: function(feature) {
                    const iso = feature.properties.iso;
                    const data = districtData[iso] || { capacity_score: 50 };
                    return {
                        fillColor: getCapacityColor(data.capacity_score),
                        weight: 1,
                        opacity: 0.8,
                        color: '#444',
                        fillOpacity: getCapacityOpacity(data.capacity_score)
                    };
                },
                onEachFeature: function(feature, layer) {
                    const iso = feature.properties.iso;
                    const data = districtData[iso] || {};
                    
                    layer.on({
                        mouseover: function(e) {
                            e.target.setStyle({
                                weight: 3,
                                color: '#00d4aa'
                            });
                        },
                        mouseout: function(e) {
                            e.target.setStyle({
                                weight: 1,
                                color: '#444'
                            });
                        },
                        click: function(e) {
                            showDistrictInfo(data);
                        }
                    });
                    
                    // Tooltip
                    const tooltipContent = `
                        <div class="tooltip-custom">
                            <div class="title">${data.name || feature.properties.name}</div>
                            <div>Installiert: ${formatNumber(data.installed_mw || 0)} MW</div>
                            <div>Windparks: ${data.windparks || 0}</div>
                            <div>Geschätzt verfügbar: ${formatNumber(data.estimated_available_mw || 0)} MW</div>
                        </div>
                    `;
                    layer.bindTooltip(tooltipContent, { className: 'tooltip-custom' });
                }
            }).addTo(heatmapLayer);
        }
        
        // Show district details
        function showDistrictInfo(data) {
            const panel = document.getElementById('district-panel');
            panel.classList.add('active');
            
            document.getElementById('district-name').textContent = data.name || '-';
            document.getElementById('district-installed').textContent = formatNumber(data.installed_mw || 0) + ' MW';
            document.getElementById('district-windparks').textContent = data.windparks || 0;
            document.getElementById('district-transformers').textContent = data.transformers || 0;
            document.getElementById('district-official').textContent = formatNumber(data.official_available_mw || 0) + ' MW';
            document.getElementById('district-estimated').textContent = formatNumber(data.estimated_available_mw || 0) + ' MW';
            
            const capacityBar = document.getElementById('capacity-bar');
            const score = data.capacity_score || 50;
            capacityBar.style.width = score + '%';
            capacityBar.style.background = getCapacityColor(score);
        }
        
        // Load wind turbines
        async function loadTurbines() {
            const response = await fetch('/api/wind-turbines');
            turbinesData = await response.json();
            
            // Update stats
            document.getElementById('total-turbines').textContent = formatNumber(turbinesData.length);
            const totalEstimatedMW = turbinesData.reduce((sum, t) => sum + (t.estimated_mw || 0), 0);
            document.getElementById('total-estimated-mw').textContent = formatNumber(Math.round(totalEstimatedMW)) + ' MW';
            
            // Create markers for each turbine
            turbinesData.forEach((t, index) => {
                if (t.lat && t.lon) {
                    // Use viridis color scale based on estimated power
                    const turbineColor = getTurbinePowerColor(t.estimated_mw || 3);
                    const marker = L.circleMarker([t.lat, t.lon], {
                        pane: 'turbinePane',
                        radius: 5,
                        fillColor: turbineColor,
                        color: '#ffffff',
                        weight: 1.5,
                        opacity: 0.9,
                        fillOpacity: 0.85
                    });
                    
                    marker.turbineData = t;
                    marker.turbineIndex = index;
                    
                    marker.bindTooltip(`
                        <div class="tooltip-custom">
                            <div class="title">${t.display_name || t.name}</div>
                            <div>Geschätzte Leistung: ${t.estimated_mw} MW</div>
                            <div>Höhe: ${t.height_m}m</div>
                            <div>Bezirk: ${t.bezirk}</div>
                            <div>Bundesland: ${t.bundesland}</div>
                            <div>Befeuerung: ${t.lighted ? '<span style="color:#ff4444">Ja</span>' : 'Nein'}</div>
                        </div>
                    `, { className: 'tooltip-custom' });
                    
                    marker.on('click', function() {
                        showTurbineModal(t);
                    });
                    
                    marker.addTo(windparksLayer);
                    turbineMarkers.push(marker);
                    
                    // Create night light marker for lighted turbines
                    if (t.lighted) {
                        const lightMarker = L.circleMarker([t.lat, t.lon], {
                            pane: 'nightLightsPane',
                            radius: 3,
                            fillColor: '#ff2222',
                            color: '#ff0000',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 1,
                            className: 'night-light-marker'
                        });
                        lightMarker.addTo(nightLightsLayer);
                        nightLightMarkers.push(lightMarker);
                    }
                }
            });
            
            // Update ranking when map moves
            map.on('moveend', updateTurbineRanking);
            updateTurbineRanking();
        }
        
        // Highlight a turbine on the map
        function highlightTurbine(turbine) {
            map.setView([turbine.lat, turbine.lon], 12);
        }
        
        // Calculate grid capacity score for a turbine based on its district
        function getGridCapacityScore(turbine) {
            // Find the district this turbine is in
            for (const [iso, data] of Object.entries(districtData)) {
                const [minLon, minLat, maxLon, maxLat] = data.bbox || [0, 0, 0, 0];
                if (turbine.lon >= minLon && turbine.lon <= maxLon && 
                    turbine.lat >= minLat && turbine.lat <= maxLat) {
                    // Return a combined score: turbine capacity weighted by grid availability
                    // Higher capacity_score means more room for new producers
                    const gridScore = data.capacity_score || 50;
                    const estimatedAvailable = data.estimated_available_mw || 0;
                    // Score = turbine MW * (grid availability factor)
                    // Turbines in areas with high available capacity score higher
                    return {
                        score: (turbine.estimated_mw || 1) * (gridScore / 50) * (1 + estimatedAvailable / 100),
                        gridScore: gridScore,
                        districtName: data.name,
                        availableMW: estimatedAvailable
                    };
                }
            }
            // Default if no district found
            return {
                score: turbine.estimated_mw || 1,
                gridScore: 50,
                districtName: 'Unbekannt',
                availableMW: 0
            };
        }
        
        // Update the turbine ranking based on current view and grid capacity
        function updateTurbineRanking() {
            const bounds = map.getBounds();
            
            // Filter turbines in current view and calculate grid scores
            const visibleTurbines = turbinesData.filter(t => {
                if (!t.lat || !t.lon) return false;
                return bounds.contains([t.lat, t.lon]);
            }).map(t => {
                const gridInfo = getGridCapacityScore(t);
                return {
                    ...t,
                    gridScore: gridInfo.score,
                    gridCapacity: gridInfo.gridScore,
                    districtName: gridInfo.districtName,
                    availableMW: gridInfo.availableMW
                };
            });
            
            // Sort by grid capacity score (higher = better for new installations)
            const sorted = [...visibleTurbines].sort((a, b) => (b.gridScore || 0) - (a.gridScore || 0));
            
            // Get top 10 and bottom 10
            const top10 = sorted.slice(0, 10);
            const bottom10 = sorted.slice(-10).reverse();
            
            // Render top 10 (best grid capacity)
            const topContainer = document.getElementById('top-turbines');
            topContainer.innerHTML = top10.map((t, i) => `
                <div class="ranking-item" onclick="highlightTurbine(turbinesData[${t.id}])" title="${t.districtName}: ${t.gridCapacity}% Kapazität">
                    <span class="rank">${i + 1}.</span>
                    <span class="name" title="${t.display_name || t.name}">${t.display_name || t.name}</span>
                    <span class="value">${t.gridCapacity}%</span>
                </div>
            `).join('');
            
            if (visibleTurbines.length === 0) {
                topContainer.innerHTML = '<div style="color: #888; font-size: 0.8rem; padding: 10px;">Keine Anlagen im Blickfeld</div>';
            }
        }
        
        // Show modal for wind turbine
        function showTurbineModal(t) {
            // Find district info
            const gridInfo = getGridCapacityScore(t);
            
            // Find nearest transformer
            let nearestTransformer = null;
            let minDist = Infinity;
            transformersData.forEach(trans => {
                if (!trans.latitude || !trans.longitude) return;
                const dist = Math.sqrt(Math.pow(t.lat - trans.latitude, 2) + Math.pow(t.lon - trans.longitude, 2));
                if (dist < minDist) {
                    minDist = dist;
                    nearestTransformer = trans;
                }
            });
            const distKm = (minDist * 111).toFixed(1); // Rough conversion to km
            
            document.getElementById('modal-title').innerHTML = `<i class="fas fa-wind"></i> ${t.display_name || t.name}`;
            document.getElementById('modal-body').innerHTML = `
                <div class="modal-section">
                    <h3><i class="fas fa-info-circle"></i> Grunddaten</h3>
                    <div class="modal-row">
                        <span class="modal-label">Standort</span>
                        <span class="modal-value">${t.standort}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Bezirk</span>
                        <span class="modal-value">${t.bezirk}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Bundesland</span>
                        <span class="modal-value">${t.bundesland}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Typ</span>
                        <span class="modal-value">${t.art}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Koordinaten</span>
                        <span class="modal-value">${t.lat.toFixed(5)}, ${t.lon.toFixed(5)}</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-tachometer-alt"></i> Technische Daten</h3>
                    <div class="modal-row">
                        <span class="modal-label">Nabenhöhe</span>
                        <span class="modal-value">${t.height_m} m</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Geschätzte Leistung</span>
                        <span class="modal-value positive">${t.estimated_mw} MW</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Leistungsklasse</span>
                        <span class="modal-value">${t.height_m >= 200 ? 'Großanlage (modern)' : t.height_m >= 150 ? 'Mittelgroß' : t.height_m >= 100 ? 'Kleinanlage' : 'Altanlage'}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Hindernisbefeuerung</span>
                        <span class="modal-value ${t.lighted ? 'negative' : ''}">${t.lighted ? '<i class="fas fa-lightbulb" style="color:#ff4444;"></i> Ja (Nachtmodus)' : 'Nein'}</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-plug"></i> Netzanbindung</h3>
                    <div class="modal-row">
                        <span class="modal-label">Bezirk-Netzkapazität</span>
                        <span class="modal-value ${gridInfo.gridScore >= 70 ? 'positive' : gridInfo.gridScore >= 30 ? 'warning' : 'negative'}">${gridInfo.gridScore}%</span>
                    </div>
                    ${nearestTransformer ? `
                    <div class="modal-row">
                        <span class="modal-label">Nächstes Umspannwerk</span>
                        <span class="modal-value">${nearestTransformer.substationName}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Entfernung</span>
                        <span class="modal-value">~${distKm} km</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">UW Verfügbar</span>
                        <span class="modal-value ${parseFloat(nearestTransformer.availableCapacity) > 0 ? 'positive' : 'negative'}">${nearestTransformer.availableCapacity || 0} MW</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-calculator"></i> Potenzialanalyse</h3>
                    <div class="modal-row">
                        <span class="modal-label">Jahresertrag (gesch.)</span>
                        <span class="modal-value">${(t.estimated_mw * 2200).toFixed(0)} MWh</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Haushalte versorgt</span>
                        <span class="modal-value">${Math.round(t.estimated_mw * 2200 / 4)}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">CO₂-Einsparung/Jahr</span>
                        <span class="modal-value positive">${(t.estimated_mw * 2200 * 0.4).toFixed(0)} t</span>
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }
        
        function showSourcesModal() {
            document.getElementById('sources-modal').classList.add('active');
        }
        
        function closeSourcesModal() {
            document.getElementById('sources-modal').classList.remove('active');
        }
        
        // Close modal on overlay click
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        document.getElementById('sources-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSourcesModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeSourcesModal();
            }
        });
        
        // Make highlightTurbine available globally
        window.highlightTurbine = function(turbine) {
            if (turbine) {
                map.setView([turbine.lat, turbine.lon], 13);
            }
        };
        
        // Get color for transformer based on capacity (white = available, red = no capacity)
        function getTransformerColor(available, booked) {
            const total = available + booked;
            if (total === 0) return 'rgba(150, 150, 150, 0.6)'; // Unknown - gray
            
            const availableRatio = available / Math.max(total, 1);
            
            // Continuous scale: white (100% available) to red (0% available)
            // White: rgb(255, 255, 255) -> Red: rgb(255, 60, 60)
            const r = 255;
            const g = Math.round(60 + 195 * availableRatio); // 60 to 255
            const b = Math.round(60 + 195 * availableRatio); // 60 to 255
            
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }
        
        // Load transformer stations
        async function loadTransformers() {
            const response = await fetch('/api/transformer-stations');
            transformersData = await response.json();
            
            transformersData.forEach((t, index) => {
                if (t.latitude && t.longitude) {
                    const available = parseFloat(t.availableCapacity) || 0;
                    const booked = parseFloat(t.bookedCapacity) || 0;
                    const color = getTransformerColor(available, booked);
                    
                    // Create square icon for transformer
                    const icon = L.divIcon({
                        className: 'transformer-icon',
                        html: `<div style="width: 10px; height: 10px; background: ${color}; border: 1.5px solid rgba(255,255,255,0.9); border-radius: 2px;"></div>`,
                        iconSize: [10, 10],
                        iconAnchor: [5, 5]
                    });
                    
                    const marker = L.marker([t.latitude, t.longitude], {
                        icon: icon,
                        pane: 'transformerPane'
                    });
                    
                    marker.transformerData = t;
                    marker.transformerIndex = index;
                    
                    marker.bindTooltip(`
                        <div class="tooltip-custom">
                            <div class="title">${t.substationName}</div>
                            <div>Verfügbar: ${available} MW / Gebucht: ${booked} MW</div>
                            <div>${t.state}</div>
                        </div>
                    `, { className: 'tooltip-custom' });
                    
                    marker.on('click', function() {
                        showTransformerModal(t);
                    });
                    
                    marker.addTo(transformersLayer);
                }
            });
        }
        
        // Show modal for transformer station
        function showTransformerModal(t) {
            const available = parseFloat(t.availableCapacity) || 0;
            const booked = parseFloat(t.bookedCapacity) || 0;
            const total = available + booked;
            const availablePercent = total > 0 ? Math.round((available / total) * 100) : 0;
            const color = getTransformerColor(available, booked);
            
            // Find nearby turbines
            const nearbyTurbines = turbinesData.filter(turb => {
                if (!turb.lat || !turb.lon) return false;
                const dist = Math.sqrt(Math.pow(turb.lat - t.latitude, 2) + Math.pow(turb.lon - t.longitude, 2));
                return dist < 0.15; // Roughly 15km
            });
            const nearbyCapacity = nearbyTurbines.reduce((sum, turb) => sum + (turb.estimated_mw || 0), 0);
            
            document.getElementById('modal-title').innerHTML = `<i class="fas fa-bolt"></i> ${t.substationName}`;
            document.getElementById('modal-body').innerHTML = `
                <div class="modal-section">
                    <h3><i class="fas fa-info-circle"></i> Grunddaten</h3>
                    <div class="modal-row">
                        <span class="modal-label">Netzbetreiber</span>
                        <span class="modal-value">${t.networkOperator}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Bundesland</span>
                        <span class="modal-value">${t.state}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Koordinaten</span>
                        <span class="modal-value">${t.latitude.toFixed(4)}, ${t.longitude.toFixed(4)}</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-plug"></i> Kapazität</h3>
                    <div class="modal-row">
                        <span class="modal-label">Gebuchte Kapazität</span>
                        <span class="modal-value">${booked} MW</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Offiziell verfügbar</span>
                        <span class="modal-value ${available > 0 ? 'positive' : 'negative'}">${available} MW</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Gesamtkapazität</span>
                        <span class="modal-value">${total} MW</span>
                    </div>
                    <div class="capacity-indicator">
                        <span style="color: #888; font-size: 0.85rem;">Auslastung:</span>
                        <div class="capacity-bar-modal">
                            <div class="capacity-bar-modal-fill" style="width: ${100 - availablePercent}%; background: ${color};"></div>
                        </div>
                        <span style="color: ${color}; font-weight: bold;">${100 - availablePercent}%</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-wind"></i> Windkraft im Umkreis (~15km)</h3>
                    <div class="modal-row">
                        <span class="modal-label">Anzahl Anlagen</span>
                        <span class="modal-value">${nearbyTurbines.length}</span>
                    </div>
                    <div class="modal-row">
                        <span class="modal-label">Installierte Leistung</span>
                        <span class="modal-value">${nearbyCapacity.toFixed(1)} MW</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3><i class="fas fa-phone"></i> Kontakt</h3>
                    <div class="modal-row">
                        <span class="modal-label">Kontakt</span>
                        <span class="modal-value" style="font-size: 0.85rem;">${t.contact || 'k.A.'}</span>
                    </div>
                    ${t.website ? `<div class="modal-row">
                        <span class="modal-label">Website</span>
                        <a href="${t.website}" target="_blank" style="color: #00d4aa;">Öffnen</a>
                    </div>` : ''}
                </div>
            `;
            
            document.getElementById('detail-modal').classList.add('active');
        }
        
        // Load production data
        async function loadProduction() {
            const response = await fetch('/api/production');
            const data = await response.json();
            
            // Update 2024 production
            const prod2024 = data.production.find(p => p.Jahr === 2024);
            if (prod2024) {
                document.getElementById('production-2024').textContent = 
                    formatNumber(Math.round(prod2024['Österreich in GWh'])) + ' GWh';
            }
            
            // Create chart
            const ctx = document.getElementById('production-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.production.map(p => p.Jahr),
                    datasets: [{
                        label: 'Erzeugung (GWh)',
                        data: data.production.map(p => p['Österreich in GWh']),
                        backgroundColor: '#00d4aa',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }
        
        // Add power grid overlay using styled SVG
        function loadGridOverlay() {
            // Bounds calibrated to align the APG grid map with the base map
            const bounds = [[46.15, 9.2], [49.15, 17.45]];
            const imageOverlay = L.imageOverlay('/static/power_grid_styled.svg', bounds, {
                opacity: 0.9,
                interactive: false,
                className: 'power-grid-overlay',
                pane: 'gridPane'
            });
            imageOverlay.addTo(gridLayer);
        }
        
        // Layer toggle handlers
        document.getElementById('layer-heatmap').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(heatmapLayer);
            } else {
                map.removeLayer(heatmapLayer);
            }
        });
        
        document.getElementById('layer-windparks').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(windparksLayer);
            } else {
                map.removeLayer(windparksLayer);
            }
        });
        
        document.getElementById('layer-transformers').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(transformersLayer);
            } else {
                map.removeLayer(transformersLayer);
            }
        });
        
        document.getElementById('layer-grid').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(gridLayer);
            } else {
                map.removeLayer(gridLayer);
            }
        });
        
        // Night mode toggle
        document.getElementById('layer-nightmode').addEventListener('change', function() {
            nightModeActive = this.checked;
            const nightLegend = document.querySelector('.night-mode-legend');
            if (nightModeActive) {
                document.body.classList.add('night-mode');
                map.addLayer(nightLightsLayer);
                if (nightLegend) nightLegend.style.display = 'flex';
            } else {
                document.body.classList.remove('night-mode');
                map.removeLayer(nightLightsLayer);
                if (nightLegend) nightLegend.style.display = 'none';
            }
        });
        
        // Initialize
        async function init() {
            await Promise.all([
                loadDistrictHeatmap(),
                loadTurbines(),
                loadTransformers(),
                loadProduction()
            ]);
            loadGridOverlay();
        }
        
        init();
    </script>
</body>
</html>
